# FAT (File Allocation Table) 文件系统总结

基于 CS162 Lecture 19 & 20

## 1. 核心架构

FAT 是最简单的文件系统架构之一（最早用于 MS-DOS）。它的设计思想是将磁盘视为一个巨大的数组，并用一张表（FAT 表）来管理这些块的连接关系。

### 磁盘布局
磁盘空间被划分为两个主要区域：
1.  **FAT 区域 (File Allocation Table)**：位于磁盘开头，存储文件块的链接信息。
2.  **数据区域 (Data Region)**：占据磁盘的大部分，存储实际的文件内容。

### 核心数据结构：FAT 表
* **定义**：FAT 表是一个线性数组。
* **索引**：数组的索引对应磁盘上的 **数据块号 (Block Number)**。
* **内容**：数组中存储的值是 **"下一个块号" (Next Block Pointer)**。
    * 如果 FAT[31] = 100，表示文件在块 31 之后的下一部分存储在块 100。
    * 特殊值（如 -1 或 EOF）表示文件结束。
    * 特殊值（如 0）表示该块空闲 (Free)。

---

## 2. 文件与目录的表示

### 文件的表示
* **链表结构**：一个文件在 FAT 中就是一条 **链表 (Linked List)**。
* **文件号 (File Number)**：文件的 ID 就是它 **第一个数据块的编号**。
* **读取流程**：要读取一个文件，系统从目录项中获取起始块号，然后查阅 FAT 表顺藤摸瓜找到所有后续块。

### 目录 (Directories)
* **目录也是文件**：目录本身是一个特殊的文件，其内容是一系列 **目录项 (Directory Entries)**。
* **目录项结构**：每个条目包含：
    * **文件名 (Name)**
    * **文件属性 (Attributes)**：如只读、隐藏等。
    * **起始块号 (Start Block)**：这是访问文件的入口。
    * **大小 (Size)**
* **关键点**：在 FAT 中，文件的元数据（Metadata）是直接存储在 **目录项** 里的，而不是像 Unix 那样存储在独立的 Inode 中。

---

## 3. 性能与特性分析

### 优点 (Pros)
* **简单 (Simple)**：实现非常容易，被广泛用于嵌入式设备、U 盘和相机卡。
* **广泛兼容 (Widely Supported)**：几乎所有操作系统都能读写 FAT。

### 缺点 (Cons)
* **随机访问极慢 (Poor Random Access)**：
    * 要读取文件的中间位置（例如第 100MB），必须从头遍历 FAT 链表，时间复杂度为 O(N)。
* **碎片化 (Fragmentation)**：
    * 随着文件创建和删除，链表会交织在一起，导致文件在物理磁盘上分布极其零散，严重影响读写性能（磁头需频繁寻道）。
* **缺乏可靠性 (Poor Reliability)**：
    * FAT 表是单点故障。如果 FAT 表损坏，所有文件链接关系丢失，整个磁盘数据作废。通常需要备份 FAT 表。
* **不支持硬链接 (No Hard Links)**：
    * 因为元数据在目录项里，无法让多个目录项共享同一个文件的元数据。
* **文件大小限制**：
    * 传统的 FAT32 单个文件不能超过 4GB。

---

## 4. 典型操作流程

### 读取文件 (Read)
1.  在目录中找到文件名对应的条目。
2.  从条目中读取 **Start Block** (例如 31)。
3.  读取数据块 31。
4.  查 FAT 表：`Next = FAT[31]`。
5.  如果 `Next != EOF`，读取数据块 `Next`，重复步骤 4。

### 创建文件 (Create)
1.  扫描 FAT 表，寻找值为 0 (Free) 的空闲项。
2.  在目录中创建一个新条目，记录文件名和找到的起始块号。
3.  将数据写入该块，并在 FAT 表中标记结束或链接到下一块。