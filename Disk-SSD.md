# 操作系统存储复习总结：HDD, SSD 与 FTL

## 1. 机械硬盘 (Hard Disk Drive, HDD)

### 1.1 物理结构与特性
HDD 是通过物理旋转的盘片和移动的磁头来读写数据的精密机械装置。
* **磁道 (Track)**：盘片上的同心圆环。
* **扇区 (Sector)**：磁道上最小的存储单位（通常是 512 Bytes 或 4KB）。
* **柱面 (Cylinder)**：所有盘片上相同半径的磁道集合。

### 1.2 磁盘访问时间 (Access Time)
这是计算题的常考点。读取一个扇区的总时间由三部分组成：

$$T_{access} = T_{seek} + T_{rotation} + T_{transfer}$$

1.  **寻道时间 (Seek Time)**：磁头移动到正确磁道（柱面）所需的时间。这是最慢的部分（通常为毫秒级）。
2.  **旋转延迟 (Rotational Latency)**：等待目标扇区旋转到磁头下方的时间。
    * **平均旋转延迟** = 旋转一周时间的一半。
    * *例如*：7200 RPM (转/分) $\rightarrow$ 120 转/秒 $\rightarrow$ 一周 8.33ms $\rightarrow$ 平均延迟 4.17ms。
3.  **传输时间 (Transfer Time)**：磁头读取数据经过的时间。取决于数据大小和传输速率。

### 1.3 调度算法 (Scheduling Algorithms)
为了减少昂贵的寻道时间，操作系统会对 I/O 请求进行排序：
* **FIFO**: 先来先服务，性能最差（可能导致磁头乱跳）。
* **SSTF (Shortest Seek Time First)**: 贪心算法，优先去最近的磁道。
    * *缺点*：容易导致边缘磁道的请求“饥饿”。
* **SCAN (电梯算法)**: 磁头来回扫描（0 -> Max -> 0）。
    * *缺点*：对中间区域偏爱，中间被访问两次，边缘只有一次。
* **C-SCAN (Circular SCAN)**: 磁头只单向扫描（0 -> Max，然后迅速复位回 0，再从 0 -> Max）。
    * *优点*：提供更**均匀的等待时间 (Uniform Wait Time)**，消除了 SCAN 对中间磁道的偏向。

### 1.4 磁道倾斜 (Track Skewing)
物理相邻的磁道，其扇区编号会有一定的偏移。这是为了给磁头换道（Switch Track）留出物理时间，保证换道后磁头刚好能读到下一圈的起始数据，实现连续读取的最优化。

---

## 2. 固态硬盘 (Solid State Drive, SSD)

### 2.1 基本原理
SSD 基于 NAND Flash 闪存技术，内部没有移动部件，全是电路。
* **Page (页)**：读写的最小单位（通常 4KB - 16KB）。
* **Block (块)**：擦除的最小单位（通常包含 64 - 256 个 Page）。

### 2.2 核心限制 (The Constraints)
SSD 与 HDD 最大的逻辑区别在于它不能像 RAM 或 HDD 那样直接“覆盖写”：
1.  **读/写**：以 Page 为单位，很快。
2.  **擦除 (Erase)**：只能以 Block 为单位，且非常慢。
3.  **禁止覆盖写 (Erase-before-Write)**：如果一个 Page 已经写了数据，想修改它，必须先擦除整个 Block。

---

## 3. 闪存转换层 (Flash Translation Layer, FTL)

由于 SSD 有上述的物理限制，但操作系统（文件系统）依然以为自己在操作一个普通的块设备（像 HDD 一样可以随意读写）。**FTL** 就是运行在 SSD 控制器里的软件/固件，它是一个“中间人”，负责“欺骗”操作系统。

### 3.1 核心功能
FTL 主要负责解决三个问题：

#### A. 逻辑到物理地址映射 (Logical-to-Physical Mapping)
* **问题**：OS 想修改逻辑块 LBA 100 的数据。但在 SSD 上，你不能直接覆盖原来的物理页。
* **解决**：
    1.  FTL 将新数据写入一个新的、空白的物理页（例如 PPN 500）。
    2.  FTL 更新映射表：现在 LBA 100 指向 PPN 500。
    3.  原来的物理页被标记为“垃圾”或“无效”。
* **结果**：OS 觉得它覆盖了旧数据，其实 SSD 只是换了个地方写（Log-structured 写法）。

It buffers small writes and aggregates them into one large write

#### B. 磨损均衡 (Wear Leveling)
* **问题**：闪存的每个 Block 都有擦除次数寿命（P/E cycles）。如果总是写同一个位置（比如文件系统的元数据区），那个 Block 会很快坏掉，导致整个 SSD 报废。
* **解决**：FTL 智能地将写入操作分散到整个 SSD 的所有 Block 上。即使 OS 一直在写同一个逻辑地址，FTL 也会把它映射到不同的物理 Block 上，确保所有 Block “一起变老”。

#### C. 垃圾回收 (Garbage Collection)
* **问题**：随着不断写入新位置，老位置变成了无效数据（Stale data），如果不清理，SSD 很快就没空页写了。
* **解决**：
    1.  FTL 找到一个包含很多无效页的 Block。
    2.  把里面仅存的几个**有效页**复制到别的地方。
    3.  **擦除**整个 Block，将其变回空白块，以供再次写入。

---

## 4. HDD vs SSD 对比总结表

| 特性 | HDD (机械硬盘) | SSD (固态硬盘) | 备注 |
| :--- | :--- | :--- | :--- |
| **内部结构** | 机械部件 (盘片、磁头) | 电子芯片 (Flash) | SSD 因无机械部件更抗物理震动 |
| **随机 I/O 性能** | 差 (受限于寻道和旋转) | **极好** | SSD 的杀手级优势 |
| **连续 I/O 性能** | 还可以 | 很好 | |
| **写入方式** | 直接覆盖写 (Overwrite) | **擦除后写** (Erase-before-Write) | SSD 需 FTL 处理 |
| **寿命限制** | 机械磨损 (很久) | **写入次数限制** (P/E Cycles) | HDD 写入寿命通常更长 |
| **物理坚固性** | **脆弱** (怕摔、怕震动) | **坚固** (抗摔) | HDD 磁头容易发生 Head Crash |
| **价格/容量** | 便宜，容量大 | 较贵 | |
| **噪音/功耗** | 有噪音，功耗较高 | 静音，低功耗 | |

### 核心记忆点
1.  **C-SCAN 优势**: 解决了 SCAN 算法对中间磁道的偏向性，提供均匀等待时间。
2.  **物理坚固性 (Robustness)**: SSD > HDD。HDD 怕摔（磁头撞击），SSD 不怕。
3.  **FTL 铁三角**: 映射 (Mapping)、磨损均衡 (Wear Leveling)、垃圾回收 (Garbage Collection)。